<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>SOC09108 - 2015 - Practical 06</title>
    <link href='../../style.css' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>

  <body>
    <img id="logo" src="../../ENU-logo.png" alt="Edinburgh Napier University logo">
    <h1>SOC09108 - 2015 - Practical 06</h1>
    <h2>Extending WordPress: security</h2>
    <p>Based on last weeks work, we will try to improve your WordPress security.</p>
    <p><strong>Errata:</strong> please have a look at the updated version of last week tutorial (or <a href="https://github.com/tdutrion/soc09108-2015/commit/2c1b8b49c5b2284950e1421d73e077f5e53d9fe8" target="_blank">the diff on Github</a>).</p>
    <p>You should already have:</p>
    <ul>
      <li>A working WordPress installation.</li>
      <li>A custom theme (full, child or both).</li>
      <li>A plugin that allow visitors to register for a newsletter (email field).</li>
    </ul>
    <p>If you do not have this setup yet, please ask as soon as you can so we work that out. The next lecture should last only an hour, the second hour being dedicated to live coding examples based on your questions, so please come and ask.</p>
    <p>While this is a fairly simple WordPress setup with just a few features, it covers the main ways to extend WordPress and should be enough to introduce security basics.</p>
    <p>Security will have to be set at different levels that we will details below:</p>
    <ul>
      <li>System level (database access permissions, filesystem permissions...)</li>
      <li>Server level (PHP validation for input/output, HTTP validation for used verbs...)</li>
      <li>Application level (application access control, login security...)</li>
    </ul>
    <p>Because that is a lot to think about, and that we are not a security class, we will only look at the concepts here and how to cover the most usual vulnerabilities.</p>
    <h2>User authentication</h2>
    <p>Have a look at your WordPress configuration file first (<code>wp-config.php</code>). Your configuration is either moved to another file and included in <code>wp-config.php</code> or your configuration is setup in this file directly. In this practical we will consider that your configuration is in the <code>wp-config.php</code> file, ask if you need help with adapting your code.</p>
    <p>The first lines of your file should look like the sample below (extracted from <code>wp-config-sample.php</code>, <a href="https://github.com/WordPress/WordPress/blob/master/wp-config-sample.php" target="_blank">a sample configuration provided in WordPress core</a>):</p>
    <pre><code class="php">
      &lt;?php
      /**#@+
       * Authentication Unique Keys and Salts.
       *
       * Change these to different unique phrases!
       * You can generate these using the {@link https://api.wordpress.org/secret-key/1.1/salt/ WordPress.org secret-key service}
       * You can change these at any point in time to invalidate all existing cookies. This will force all users to have to log in again.
       *
       * @since 2.6.0
       */
      define('AUTH_KEY',         'put your unique phrase here');
      define('SECURE_AUTH_KEY',  'put your unique phrase here');
      define('LOGGED_IN_KEY',    'put your unique phrase here');
      define('NONCE_KEY',        'put your unique phrase here');
      define('AUTH_SALT',        'put your unique phrase here');
      define('SECURE_AUTH_SALT', 'put your unique phrase here');
      define('LOGGED_IN_SALT',   'put your unique phrase here');
      define('NONCE_SALT',       'put your unique phrase here');
    </code></pre>
    <p>If you have these default keys, you should changed them with a set generated by <a href="https://api.wordpress.org/secret-key/1.1/salt/" target="_blank">using the WordPress API</a>. This will invalidate any session you have, and therefore disconnect evey logged in users.</p>
    <p>If you do not know what a salt is, please read this article: <a href="https://ttmm.io/tech/wordpress-password-hashing/">ttmm.io: WordPress password hashing</a>. In a nutshell, a salt is a string used to lengthen plain text strings before hashing, and therefore have a more complex string stored than the basic string used as password for instance.</p>
    <p>The second step in order to secure your WordPress login page would be setting up an ssl certificate and move all the connexions to https. Because we can not try that here, just know you may use Virtualbox to setup your own SSL certificate on a Linux virtualised system with LAMP installed on it, or you could use free offers from the <a href="https://education.github.com/pack" target="_blank">Github Student pack</a>. Your hosting provider will generally offer an ssl option on your webhosting package anyway.</p>
    <p>Two other issues are remaining and can be solved with adding plugins: using a Two Factor Authentication and limiting the number of login attemps to avoid brute force attacks. You can try to install <a href="https://wordpress.org/plugins/limit-login-attempts/developers/" target="_blank">Limit Login Attempts</a> and <a href="https://henrik.schack.dk/google-authenticator-for-wordpress/" target="_blank">Google authenticator</a>. If you have a smartphone with Google Authenticator installed, please try to setup your account (in your user profile).</p>
    <p>As discussed in the lecture, you should also make sure there are no users with usernames such as <code>admin</code> or <code>administrator</code>.</p>
    <h2>Securing your plugin</h2>
    <p>While the first part was about testing tools provided by developers to secure your users access, we are now going to make a few changes to last week plugin in order to secure it from attacks.</p>
    <p>First, we need to make sure the user input has been limited and validated to the type of content you want to have. When the user is submitting the form, the information is transmitted over to the webserver and processed by the PHP interpreter.</p>
    <p>You should have the following code (or something similar) in your plugin main file:</p>
    <pre><code class="php">
      function napier_newsletter() {
          if (isset($_POST['napier_newsletter_submit'])) {
              $emailAddress = filter_input(INPUT_POST, 'napier_newsletter_email');
              form_validation($emailAddress);
              form_processing($emailAddress);
          }
          form_rendering();
      }
    </code></pre>
    <p>As you can see, the code here is filtering the email address. In some tutorials you may find online, developers are accessing parameters from the <code class="php">$_POST</code> global array, but using the <a href="http://php.net/manual/en/function.filter-input.php" target="_blank">filter_input</a> we already make sure only authorised characters are used (others will be sanitised or removed).</p>
    <p>As an experience, remove this protection and access the global post array directly:</p>
    <pre><code class="php">$emailAddress = filter_input(INPUT_POST, 'napier_newsletter_email');</code></pre>
    <pre><code class="php">$emailAddress = $_POST['napier_newsletter_email'];</code></pre>
    <br>
    <pre><code class="php">
      if (!is_email($emailAddress)) {
          $napier_newsletter_errors->add('email_invalid', 'Email is not valid');
      }
      $email_exists = $wpdb->get_var("SELECT COUNT(*) FROM {$wpdb->prefix}napier_newsletter");
      if ($email_exists > 0) {
          $napier_newsletter_errors->add('email', 'Email address already registered');
      }
    </code></pre>
    <pre><code class="php">
      /*if (!is_email($emailAddress)) {
        $napier_newsletter_errors->add('email_invalid', 'Email is not valid');
      }
      $email_exists = $wpdb->get_var("SELECT COUNT(*) FROM {$wpdb->prefix}napier_newsletter");
      if ($email_exists > 0) {
        $napier_newsletter_errors->add('email', 'Email address already registered');
      }*/
    </code></pre>
    <br>
    <pre><code class="php">&lt;input type=&quot;email&quot; name=&quot;napier_newsletter_email&quot; value=&quot;&lt;?= (isset($_POST[&quot;napier_newsletter_email&quot;]) ? esc_attr($_POST[&quot;napier_newsletter_email&quot;]) : '') ?&gt;&quot; size=&quot;255&quot;&gt;</code></pre>
    <pre><code class="php">&lt;input type=&quot;text&quot; name=&quot;napier_newsletter_email&quot; value=&quot;&lt;?= (isset($_POST[&quot;napier_newsletter_email&quot;]) ? esc_attr($_POST[&quot;napier_newsletter_email&quot;]) : '') ?&gt;&quot; size=&quot;255&quot;&gt;</code></pre>
    <p>Now, you can try to pass along different strings in the input field and see how the system behave.</p>
    <pre><code class="html">&lt;script&gt;alert('test');&lt;/script&gt;</code></pre>
    <p><em>If you are using Google Chrome, use the developer tools to see the errors, as Chrome does not allow XSS (<code>The XSS Auditor refused to execute a script in 'http://localhost:9000/' because its source code was found within the request. The auditor was enabled as the server sent neither an 'X-XSS-Protection' nor 'Content-Security-Policy' header.</code>). I haven't verified the behavious on other web browsers, but you should either have a javascript alert or some kind of error in the developer tools.</em></p>
    <pre><code class="html">&lt;style&gt;body { height: 100vh; width: 100vh; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 999; background: silver; }&lt;/style&gt;</code></pre>
    <p><em>This should only alter your style.</em></p>
    <p>Use your imagination along with the resources found in the lecture and try other attacks. You should see that WordPress already set a few defences for you. Then set your protection back and try to improve it as you can.</p>
    <p>As an other example, we will try to protect the form to be filled from outside of your website (disallow Cross Site Request Forgery). Outside of your project (anywhere on your computer), create an html file (let's call it <code>test.html</code>):</p>
    <pre><code class="html">
      &lt;form action=&quot;http://localhost:9000/&quot; method=&quot;post&quot;&gt;
        &lt;p&gt;
          &lt;label&gt;
              Email address:
              &lt;input type=&quot;text&quot; name=&quot;napier_newsletter_email&quot; size=&quot;255&quot;&gt;
         &lt;/label&gt;
        &lt;/p&gt;
        &lt;p&gt;
          &lt;input type=&quot;submit&quot; name=&quot;napier_newsletter_submit&quot; value=&quot;Register&quot;/&gt;
        &lt;/p&gt;
      &lt;/form&gt;
    </code></pre>
    <p>Use your website url as action, as we have the plugin form on every page (through the theme), any url on your website may work. Open this file in your web browser and submit the form with a valid email address that hasn't been already registered.</p>
    <p>You should have been able to register from outside the website. In order to avoid this behaviour, we will implement some sort of CSRF protection.</p>
    <p>Please read <a href="https://css-tricks.com/wordpress-front-end-security-csrf-and-nonces/" target="_blank">WordPress front end security csrf and nonces</a> and try to implement this security on your plugin.</p>
    <h2>System level security</h2>
    <p>Because you can not change rights on the university computers, we will not cover this in details. Just keep in mind that you can have filesystems and databases with read-only mode or restricted access, and use it accordingly.</p>
    <a href="https://github.com/tdutrion/soc09108-2015"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/567c3a48d796e2fc06ea80409cc9dd82bf714434/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_darkblue_121621.png"></a>
  </body>
</html>
